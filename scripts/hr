#!/usr/bin/python2

from sys import *
import os
from os import system, mkdir
from os.path import basename
from glob import glob

args = list(argv[1:])

basura = 'basura_delete_later_once_scripts_finish_running_hr'
basura2 = 'basura_delete_later_once_scripts_finish_running_hr2'

def print_to(x): return 'cat > %s' % x

def go_through(cmd, replacement, destination, prints=(stderr,)):
    for targ in prints: print >>targ, 'times are printed as "real user sys"'
    for filename in sorted(glob('input/input*.txt')):
        outfilename = filename.replace('input', replacement, 1).replace('input', 'output', 1)
        for targ in prints: print >>targ, 'DOING', outfilename
        system('/usr/bin/time -f "TIME %%es %%Us %%Ss" %s < %s | %s' % (cmd, filename, destination(outfilename)))
        yield outfilename

def unknown(cmd):
    print >>stderr, "unrecognized command:", cmd
    exit(1)


if not args or args[0] == '-h':
    print 'USAGE:'
    script_name = basename(argv[0])
    print script_name, "gen xxx [cmd]      - generates output files to folder 'xxx'"
    print script_name, "genxxx [cmd]       - equivalent to 'gen xxxput [cmd]'"
    print script_name, "test [cmd]         - checks a program against existing data in output/"
    print script_name, "testc [cmd]        - similar to 'test', but doesn't print the output of diff"
    print script_name, "run [cmd]          - just runs the program across all files, and prints to stdout."
    print script_name, "runboth [cmd]      - similar to 'run', but also prints the metadata to stdout, not just to stderr."
elif args[0].startswith('gen'):

    if args[0] == 'gen':
        args = args[1:]
    else:
        args[0] = args[0][len('gen'):] + 'put'

    out = args[0]

    try:
        mkdir(out)
    except OSError:
        pass

    for outfilename in go_through(' '.join(args[1:]), out, print_to):
        pass
elif args[0].startswith('test'):
    fileverb = False
    if args[0] not in ('testget', 'testc', 'test'):
        unknown(args[0])

    correct = files = 0
    for outfilename in go_through(' '.join(args[1:]), 'output', lambda x: print_to(basura)):
        if args[0] == 'test':
            system("diff %s %s | head -n 100" % (basura, outfilename))
        status = system("diff %s %s > %s" % (basura, outfilename, basura2))
        files += 1
        if status == 0:
            correct += 1
        print >>stderr, "correct" if status == 0 else "WRONG!!!!!!!!!", outfilename if args[0] == 'testget' else ''

    print >>stderr, "{} out of {} correct".format(correct, files)
    # remove basura and basura2
    for name in basura, basura2:
        try:
            os.remove(name)
        except OSError:
            pass

elif args[0].startswith('run'):
    if args[0] == 'run':
        prints = stderr,
    elif args[0] == 'runboth':
        prints = stdout, stderr
    else:
        unknown(args[0])

    for outfilename in go_through(' '.join(args[1:]), 'input', lambda x: 'cat', prints=prints):
        pass

else:
    unknown(args[0])
